# 🔦 LiDAR 다중 센서 로봇 시뮬레이터 (`simulator.ts`)

## 📖 개요

`simulator.ts`는 **다중 LiDAR 센서가 장착된 로봇의 가상 환경 시뮬레이터**입니다.  
실제 LiDAR 하드웨어 없이도 TCP 소켓 기반으로 센서 데이터를 생성·송출하여, 클라이언트(시각화 서버 등)에서 실시간으로 라이다 데이터를 수신하고 테스트할 수 있도록 합니다.

---

## 🏗️ 아키텍처

```
┌─────────────────────────────────────────────────────┐
│               가상 환경 (50m × 50m 방)                │
│                                                     │
│       ● ← 원형 장애물 (반경 0.5m, 원운동)             │
│                                                     │
│              ┌──────────────┐                       │
│              │    🤖 로봇    │                       │
│              │              │                       │
│   [Port 8004]│ ← (왼쪽)    │[Port 8002] → (오른쪽)  │
│              │  (0,0) 중심   │                       │
│              │ ↑ (앞쪽)     │                       │
│              │[Port 8001]   │                       │
│              │ ↓ (뒤쪽)     │                       │
│              │[Port 8003]   │                       │
│              └──────────────┘                       │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

## ⭐ 주요 기능

### 1. 🔄 다중 센서 시뮬레이션
- **4개의 독립적인 LiDAR 센서**를 동시에 시뮬레이션합니다.
- 각 센서는 로봇 몸체의 **앞(Front), 오른쪽(Right), 뒤(Back), 왼쪽(Left)**에 배치되어 있습니다.
- 각 센서는 **독립 TCP 포트**(8001~8004)에서 개별 서버로 동작합니다.

| 방향 | 포트 | 로봇 중심 기준 위치 (x, y) | 설치 각도 |
|------|------|---------------------------|-----------|
| Front (앞) | 8001 | (0.5, 0.0) | 0° |
| Right (오른쪽) | 8002 | (0.0, -0.5) | -90° |
| Back (뒤) | 8003 | (-0.5, 0.0) | 180° |
| Left (왼쪽) | 8004 | (0.0, 0.5) | 90° |

### 2. 🎯 가상 환경 Ray Casting
- **50m × 50m 크기의 정사각형 방**을 가상 환경으로 구성합니다.
- 센서에서 레이저를 발사하여 **벽과의 교차점**을 계산합니다 (Ray-Wall Intersection).
- 시뮬레이션 각 스캔에서 **수직 벽(X축)** 및 **수평 벽(Y축)**과의 거리를 계산합니다.

### 3. 🔵 동적 장애물 시뮬레이션
- **원형 장애물**이 원점을 중심으로 반경 3m의 **원운동**을 합니다.
- 장애물의 물리적 반경은 **0.5m**입니다.
- **Ray-Circle Intersection** 알고리즘을 사용하여 레이저와 장애물의 교차를 정밀하게 계산합니다.
- 전역 타이머(`globalPhase`)로 모든 센서에서 **동기화된 장애물 위치**를 보장합니다.

### 4. 📡 TCP 소켓 기반 실시간 데이터 스트리밍
- 각 센서는 **TCP 서버**로 동작하며, 다수의 클라이언트 연결을 지원합니다.
- **50ms 간격** (20Hz)으로 스캔 데이터를 브로드캐스트합니다.
- 연결된 **모든 소켓**에 동시 전송합니다.

### 5. 📦 커스텀 바이너리 프로토콜
- **STX(0x02) / ETX(0x03)** 프레이밍을 사용하는 패킷 구조를 따릅니다.
- 패킷 구조:

```
[STX] [4자리 HEX 길이] [,페이로드] [ETX]
```

- 지원하는 **명령어(Command)**:

| 명령어 | 설명 | 응답 |
|--------|------|------|
| `SensorStart` | 스캔 데이터 스트리밍 시작 | `sRA,SensorStart,1` |
| `SensorStop` | 스캔 데이터 스트리밍 중지 | `sRA,SensorStop,1` |
| `LSScanDataConfig` | 스캔 설정 변경 (쓰기) | `sWA,LSScanDataConfig,1` |
| 기타 명령 | 범용 응답 반환 | `sRA,{command},1` |

### 6. 📊 스캔 데이터 패킷 구조
스트리밍 데이터는 아래 헤더 필드와 거리 데이터로 구성됩니다:

| 필드 | 설명 |
|------|------|
| `sSN` | 메시지 타입 (스캔 알림) |
| `LidarData` | 데이터 식별자 |
| `SimDevice` | 디바이스 이름 |
| `v1.0` | 프로토콜 버전 |
| `ScanCounter` | 스캔 카운터 (HEX) |
| `minAngle` | 시작 각도 (× 10000, HEX) |
| `resolution` | 각도 분해능 (× 10000, HEX) |
| `pointCount` | 거리 데이터 포인트 수 |
| `DIST1` | 거리 데이터 채널 식별자 |
| `distances...` | 각 포인트의 거리값 (mm, HEX) |

### 7. 🎲 노이즈 시뮬레이션
- 각 측정 거리에 **±1cm(2cm 범위)의 랜덤 노이즈**를 추가하여 실제 센서의 측정 오차를 재현합니다.

---

## ⚙️ 스캔 설정 (기본값)

| 항목 | 값 | 설명 |
|------|----|------|
| 시작 각도 | -45° | 스캔 시작 각도 |
| 종료 각도 | 225° | 스캔 종료 각도 |
| 분해능 | 0.333° | 각도 스텝 (약 811개 포인트/스캔) |

> 전체 스캔 범위: **270°** (= 225° - (-45°))

---

## 🚀 실행 방법

```bash
# TypeScript 직접 실행 (ts-node 등 사용)
npx ts-node lsc_server/simulator.ts

# 또는 컴파일 후 실행
tsc lsc_server/simulator.ts
node lsc_server/simulator.js
```

실행 시 콘솔 출력:
```
--- Multi-Sensor Robot Simulator Starting ---
Environment: 50m x 50m Square Room
[Sim 8001] Robot Sensor at (x:0.5, y:0, th:0°)
[Sim 8002] Robot Sensor at (x:0, y:-0.5, th:-90°)
[Sim 8003] Robot Sensor at (x:-0.5, y:0, th:180°)
[Sim 8004] Robot Sensor at (x:0, y:0.5, th:90°)
```

---

## 🔗 클라이언트 연결

TCP 소켓으로 해당 포트에 접속한 뒤, 아래 명령을 전송하면 데이터 수신이 시작됩니다:

```
[STX][길이][,sRN,SensorStart][ETX]
```

---

## 📁 핵심 구성 요소

| 구성 요소 | 설명 |
|-----------|------|
| `SensorPose` (인터페이스) | 센서의 위치(x, y), 포트, 설치 각도를 정의 |
| `SENSOR_CONFIGS` (배열) | 4방향 센서 배치 설정 |
| `LidarSimulator` (클래스) | 개별 센서 시뮬레이터 — TCP 서버, 명령 처리, Ray Casting, 데이터 전송 담당 |
| `toHex()` | 숫자를 HEX 문자열로 변환하는 유틸리티 |
| `createPacket()` | STX/ETX 프레이밍 패킷을 생성하는 유틸리티 |
| `globalPhase` | 전역 장애물 애니메이션 위상 (모든 센서 동기화) |

---

## 📌 주의사항

- 본 시뮬레이터는 **개발 및 테스트 목적**으로만 사용됩니다.
- 실제 LiDAR 프로토콜(SICK 등)과 **유사한 구조**를 따르지만, 완전히 동일하지는 않습니다.
- 방 크기(`ROOM_SIZE`), 장애물 크기/경로 등은 소스 코드 상단의 상수를 수정하여 조정할 수 있습니다.
