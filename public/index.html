<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¼ì´ë‹¤ ë°ì´í„° ëª¨ë‹ˆí„°</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        input[type="text"], input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-connect {
            background-color: #4CAF50;
            color: white;
        }
        .btn-disconnect {
            background-color: #f44336;
            color: white;
        }
        .btn-command {
            background-color: #2196F3;
            color: white;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .info-item {
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .info-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .chart-container {
            position: relative;
            height: 400px;
        }
        .log {
            background: #1e1e1e;
            color: #fff;
            padding: 10px;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” ë¼ì´ë‹¤ ë°ì´í„° ëª¨ë‹ˆí„°</h1>
            <div class="controls">
                <div class="input-group">
                    <input type="text" id="ip" placeholder="IP ì£¼ì†Œ" value="192.168.0.10">
                    <input type="number" id="port" placeholder="í¬íŠ¸" value="8000">
                    <button class="btn-connect" onclick="connect()">ì—°ê²°</button>
                    <button class="btn-disconnect" onclick="disconnect()">ì—°ê²° í•´ì œ</button>
                </div>
                <div class="input-group">
                    <input type="text" id="command" placeholder="ëª…ë ¹ì–´" value="sMN LMCstartmeas">
                    <button class="btn-command" onclick="sendCommand()">ì „ì†¡</button>
                </div>
            </div>
            <div id="status" class="status disconnected">ì—°ê²° ì•ˆë¨</div>
        </div>

        <div class="dashboard">
            <div class="panel">
                <h3>ğŸ“Š ìŠ¤ìº” ì •ë³´</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">ìŠ¤ìº” ì¹´ìš´í„°</div>
                        <div class="info-value" id="scanCounter">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ìŠ¤ìº” ì£¼íŒŒìˆ˜</div>
                        <div class="info-value" id="scanFreq">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ì¸¡ì • ì£¼íŒŒìˆ˜</div>
                        <div class="info-value" id="measFreq">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ì‹œì‘ ê°ë„</div>
                        <div class="info-value" id="angleBegin">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ê°ë„ í•´ìƒë„</div>
                        <div class="info-value" id="angleResol">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ë°ì´í„° ê°œìˆ˜</div>
                        <div class="info-value" id="amountOfData">-</div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h3>ğŸ“ˆ ê±°ë¦¬ ë°ì´í„°</h3>
                <div class="chart-container">
                    <canvas id="rangeChart"></canvas>
                </div>
            </div>

            <div class="panel">
                <h3>ğŸ“¡ ì‹ í˜¸ ê°•ë„</h3>
                <div class="chart-container">
                    <canvas id="rssiChart"></canvas>
                </div>
            </div>

            <div class="panel">
                <h3>ğŸ“ ë¡œê·¸</h3>
                <div id="log" class="log"></div>
            </div>
        </div>
    </div>

    <script>
        let rangeChart, rssiChart;
        let ws;

        function initCharts() {
            // ê±°ë¦¬ ì°¨íŠ¸
            const rangeCtx = document.getElementById('rangeChart').getContext('2d');
            rangeChart = new Chart(rangeCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ê±°ë¦¬ (m)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ê±°ë¦¬ (m)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ê°ë„'
                            }
                        }
                    }
                }
            });

            // ì‹ í˜¸ ê°•ë„ ì°¨íŠ¸
            const rssiCtx = document.getElementById('rssiChart').getContext('2d');
            rssiChart = new Chart(rssiCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ì‹ í˜¸ ê°•ë„',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'RSSI'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ê°ë„'
                            }
                        }
                    }
                }
            });
        }

        function connect() {
            const ip = document.getElementById('ip').value;
            const port = document.getElementById('port').value;
            
            fetch('/connect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ ip, port: parseInt(port) })
            })
            .then(response => response.json())
            .then(data => {
                updateStatus(data.status === 'connected');
                addLog(`ì—°ê²° ì‹œë„: ${ip}:${port}`);
                if (data.status === 'connected') {
                    addLog('âœ… ì—°ê²° ì„±ê³µ');
                    initWebSocket();
                } else {
                    addLog(`âŒ ì—°ê²° ì‹¤íŒ¨: ${data.message || data.status}`);
                }
            })
            .catch(error => {
                addLog(`âŒ ì—°ê²° ì—ëŸ¬: ${error.message}`);
            });
        }

        function disconnect() {
            fetch('/disconnect', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                updateStatus(false);
                addLog('ğŸ”Œ ì—°ê²° í•´ì œ');
                if (ws) {
                    ws.close();
                    ws = null;
                }
            });
        }

        function sendCommand() {
            const command = document.getElementById('command').value;
            fetch('/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ command })
            })
            .then(response => response.json())
            .then(data => {
                addLog(`ğŸ“¤ ëª…ë ¹ì–´ ì „ì†¡: ${command}`);
                if (data.status === 'error') {
                    addLog(`âŒ ëª…ë ¹ì–´ ì—ëŸ¬: ${data.message}`);
                }
            });
        }

        function initWebSocket() {
            if (ws) {
                ws.close();
            }
            
            ws = new WebSocket(`ws://${window.location.host}`);
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'scan') {
                    updateScanData(data.data);
                }
            };
            
            ws.onopen = () => {
                addLog('ğŸ”— WebSocket ì—°ê²°ë¨');
            };
            
            ws.onclose = () => {
                addLog('ğŸ”Œ WebSocket ì—°ê²° ì¢…ë£Œ');
            };
        }

        function updateScanData(data) {
            // ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('scanCounter').textContent = data.scanCounter;
            document.getElementById('scanFreq').textContent = data.scanFreq + ' Hz';
            document.getElementById('measFreq').textContent = data.measFreq + ' Hz';
            document.getElementById('angleBegin').textContent = data.angleBegin + 'Â°';
            document.getElementById('angleResol').textContent = data.angleResol + 'Â°';
            document.getElementById('amountOfData').textContent = data.amountOfData;

            // ì°¨íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸
            const angles = [];
            for (let i = 0; i < data.amountOfData; i++) {
                angles.push((data.angleBegin + i * data.angleResol).toFixed(1) + 'Â°');
            }

            rangeChart.data.labels = angles;
            rangeChart.data.datasets[0].data = data.ranges;
            rangeChart.update();

            rssiChart.data.labels = angles;
            rssiChart.data.datasets[0].data = data.rssi;
            rssiChart.update();

            addLog(`ğŸ“Š ìŠ¤ìº” ë°ì´í„° ìˆ˜ì‹ : ${data.amountOfData}ê°œ í¬ì¸íŠ¸`);
        }

        function updateStatus(connected) {
            const statusEl = document.getElementById('status');
            if (connected) {
                statusEl.textContent = 'ì—°ê²°ë¨';
                statusEl.className = 'status connected';
            } else {
                statusEl.textContent = 'ì—°ê²° ì•ˆë¨';
                statusEl.className = 'status disconnected';
            }
        }

        function addLog(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        // ì´ˆê¸°í™”
        initCharts();
        addLog('ğŸš€ ë¼ì´ë‹¤ ëª¨ë‹ˆí„° ì‹œì‘ë¨');
    </script>
</body>
</html>
